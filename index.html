```html
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Shop — Libreria Pattern Creativi (Performance)</title>

  <style>
    :root{
      --tt-pink:#FE2C55;
      --tt-cyan:#25F4EE;
      --bg:#0B0B10;
      --line:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --text:#F7F7FB;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(37,244,238,.18), transparent 60%),
        radial-gradient(1000px 600px at 85% 10%, rgba(254,44,85,.16), transparent 55%),
        radial-gradient(900px 500px at 40% 110%, rgba(37,244,238,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 18px 72px;}

    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:16px 18px;border:1px solid var(--line);border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:14px;z-index:50;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .logo{
      width:38px;height:38px;border-radius:14px;position:relative;
      background:
        linear-gradient(135deg, rgba(37,244,238,.95), rgba(37,244,238,.35)),
        radial-gradient(20px 20px at 20% 20%, rgba(254,44,85,.85), transparent 60%);
      box-shadow:0 10px 25px rgba(37,244,238,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .logo::after{
      content:"";position:absolute;inset:8px;border-radius:10px;
      background:linear-gradient(135deg, rgba(254,44,85,.92), rgba(254,44,85,.15));
      opacity:.9;mix-blend-mode: screen;
    }
    .brand h1{margin:0;font-size:15px;letter-spacing:.2px;line-height:1.2;}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted2);}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .btn{
      cursor:pointer;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--text);
      padding:10px 12px;border-radius:999px;font-size:12px;
      transition:transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.20)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color: rgba(37,244,238,.35);
      background: linear-gradient(135deg, rgba(37,244,238,.20), rgba(254,44,85,.16));
      box-shadow:0 10px 30px rgba(254,44,85,.10);
    }

    .hero{display:grid;grid-template-columns: 1.6fr 1fr;gap:16px;margin:18px 0 16px;}
    @media (max-width: 980px){.hero{grid-template-columns:1fr}.brand{min-width:unset;}}
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.035);
      border-radius:var(--radius2);
      padding:16px;
      box-shadow:0 16px 45px rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
    }
    .hero h2{margin:0 0 8px;font-size:18px}
    .hero p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}
    .sectionTitle{margin-top:14px;font-size:12px;color:rgba(255,255,255,.85);letter-spacing:.2px;font-weight:600;}
    .list{margin:10px 0 0;padding-left:16px;color:rgba(255,255,255,.80);font-size:12px;line-height:1.55}
    .callout{
      margin-top:12px;font-size:12px;color:rgba(255,255,255,.80);
      padding:10px 12px;border:1px solid rgba(255,255,255,.14);
      border-radius:14px;background:rgba(0,0,0,.14);
    }

    .stats{display:grid;grid-template-columns: repeat(2, 1fr);gap:12px;}
    .stat{border:1px solid var(--line);border-radius:18px;padding:12px;background:rgba(255,255,255,.03);}
    .stat .k{font-size:12px;color:var(--muted2)}
    .stat .v{font-size:18px;margin-top:6px;letter-spacing:.2px}
    .stat .tag{
      margin-top:8px;font-size:11px;color:rgba(255,255,255,.72);
      display:inline-flex;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.80);
      padding:7px 10px;border-radius:999px;font-size:12px;
      cursor:pointer;user-select:none;
    }
    .chip.on{
      border-color: rgba(37,244,238,.45);
      background: linear-gradient(135deg, rgba(37,244,238,.20), rgba(254,44,85,.10));
    }

    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.6fr repeat(4, 1fr) 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 1100px){
      .controls{grid-template-columns:1fr 1fr;align-items:stretch;}
    }
    label{display:block;font-size:12px;color:var(--muted2);margin:0 0 6px;}
    .input, .select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    .input::placeholder{color:rgba(255,255,255,.45)}
    .select option{background:#101018}

    .grid{margin-top:16px;display:grid;grid-template-columns: repeat(3, 1fr);gap:12px;}
    @media (max-width: 980px){.grid{grid-template-columns: repeat(2, 1fr);}}
    @media (max-width: 620px){.grid{grid-template-columns: 1fr;}}
    .pattern{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:14px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition:transform .08s ease, border-color .2s ease, background .2s ease;
      min-height:155px;
    }
    .pattern:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025));
    }
    .pattern::before{
      content:"";
      position:absolute;
      top:-60px; right:-70px;
      width:180px; height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(37,244,238,.35), transparent 60%),
                  radial-gradient(circle at 60% 60%, rgba(254,44,85,.25), transparent 60%);
      filter: blur(2px);
      opacity:.85;
      transform: rotate(10deg);
      pointer-events:none;
    }
    .p-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .pid{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.75);
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .status{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      color:rgba(255,255,255,.80);
      white-space:nowrap;
    }
    .status.validated{border-color:rgba(37,244,238,.45)}
    .status.tested{border-color:rgba(255,255,255,.22)}
    .status.candidate{border-color:rgba(254,44,85,.30)}
    .status.retired{border-color:rgba(254,44,85,.45); opacity:.9}

    .p-name{margin:10px 0 6px;font-size:15px;letter-spacing:.2px}
    .p-meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted2);font-size:12px;margin-top:8px;}
    .badge{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      color:rgba(255,255,255,.75);
    }
    .badge.hot{border-color:rgba(254,44,85,.40)}
    .badge.cool{border-color:rgba(37,244,238,.40)}

    .footer{
      margin-top:18px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted2);
      font-size:12px;
      align-items:center;
    }

    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.62);
      display:none;align-items:center;justify-content:center;padding:20px;z-index:100;
    }
    .modal.on{display:flex}
    .modalbox{
      width:min(920px, 100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(800px 400px at 15% 0%, rgba(37,244,238,.12), transparent 60%),
        radial-gradient(800px 400px at 85% 0%, rgba(254,44,85,.12), transparent 60%),
        rgba(10,10,16,.98);
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalhead{
      padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
    }
    .modalhead h3{margin:0;font-size:16px}
    .modalhead .sub{margin-top:6px;color:var(--muted2);font-size:12px;line-height:1.35}
    .modalcontent{
      padding:14px 16px 18px;
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){.modalcontent{grid-template-columns:1fr}}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .panel h4{margin:0 0 10px;font-size:13px;color:rgba(255,255,255,.90);}
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 10px;
      font-size:12px;
      color:var(--muted);
      align-items:start;
    }
    .kv b{color:rgba(255,255,255,.85);font-weight:600;}
    .steps{display:flex;flex-direction:column;gap:8px;}
    .step{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px;
      background:rgba(0,0,0,.18);
    }
    .step .t{font-family:var(--mono);font-size:11px;color:rgba(255,255,255,.78);}
    .step .d{margin-top:6px;font-size:12px;color:rgba(255,255,255,.82);line-height:1.45;}
    .modalactions{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
      padding:12px 16px 16px;border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .toast{
      position:fixed;bottom:16px;left:50%;
      transform:translateX(-50%);
      background:rgba(15,15,22,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:10px 14px;
      font-size:12px;
      color:rgba(255,255,255,.85);
      display:none;
      gap:8px;
      align-items:center;
      z-index:120;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
    }
    .toast.on{display:inline-flex}
    .dot{
      width:9px;height:9px;border-radius:99px;
      background:linear-gradient(135deg, var(--tt-cyan), var(--tt-pink));
      box-shadow:0 0 0 4px rgba(37,244,238,.12);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Libreria Pattern Creativi</h1>
          <p>Ricette pratiche per contenuti che convertono su TikTok Shop</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="dataStatus">Sto caricando…</span>
        <button class="btn" id="btnReload">↻ Aggiorna</button>
        <button class="btn" id="btnExport">⬇ Esporta</button>
        <button class="btn primary" id="btnHow">✦ Guida</button>
      </div>
    </div>

    <div class="hero">
      <div class="card">
        <h2>Cos’è questa libreria</h2>
        <p>
          Una raccolta di pattern orientati alla <b>conversione</b>: modelli replicabili con ricette chiare e indicazioni operative.
          L’obiettivo è aumentare il <b>ROAS</b> migliorando la supply creativa (volume utile, iterazione, efficienza).
        </p>

        <div class="sectionTitle">Come usarla (ogni settimana)</div>
        <ul class="list">
          <li>Scegli <b>2 pattern “Validati”</b> da eseguire.</li>
          <li>Scegli <b>2 pattern “In test”</b> per esplorare nuove strade.</li>
          <li>Ogni pattern produce varianti: cambia <b>hook</b>, prova, angolo, scenario.</li>
          <li>Un video = un’idea principale: <b>hook</b> forte, <b>prova</b> concreta, <b>chiusura</b> chiara.</li>
        </ul>

        <div class="callout">
          “Validato” non significa “per sempre”: se cambia offerta, categoria o pubblico, si retesta.
        </div>

        <div class="chips">
          <div class="chip on" data-quick="status:Validated">Validati</div>
          <div class="chip" data-quick="status:Tested">In test</div>
          <div class="chip" data-quick="funnel:BOFU">BOFU</div>
          <div class="chip" data-quick="funnel:MOFU">MOFU</div>
          <div class="chip" data-quick="productionLevel:Low">Produzione bassa</div>
          <div class="chip" data-quick="mechanism:Hook + Proof">Hook + prova</div>
          <div class="chip" data-quick="mechanism:Proof + Offer">Prova + offerta</div>
        </div>
      </div>

      <div class="card">
        <div class="stats">
          <div class="stat">
            <div class="k">Pattern in libreria</div>
            <div class="v" id="statCount">—</div>
            <div class="tag" id="statFiltered">Mostrati: —</div>
          </div>
          <div class="stat">
            <div class="k">Focus</div>
            <div class="v">ROAS</div>
            <div class="tag">Conversion-first</div>
          </div>
          <div class="stat">
            <div class="k">Cosa conta</div>
            <div class="v">Prova</div>
            <div class="tag">Demo / dettagli / confronto</div>
          </div>
          <div class="stat">
            <div class="k">Cosa evitare</div>
            <div class="v">Dispersione</div>
            <div class="tag">Troppe idee, poca chiarezza</div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:14px;">Standard di qualità (pochi ma seri)</div>
        <ul class="list" style="margin-top:8px;">
          <li>Il prodotto deve essere <b>visibile subito</b>.</li>
          <li><b>Una sola promessa</b> per video + testo a schermo leggibile.</li>
          <li>Claim: solo ciò che puoi sostenere con <b>prova</b>.</li>
          <li>Ogni batch deve includere: demo + obiezioni + offerta (mix).</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <div>
          <label for="q">Cerca</label>
          <input class="input" id="q" placeholder="Es. demo, obiezione, confronto, bundle, unboxing…" />
        </div>

        <div>
          <label for="funnel">Funnel</label>
          <select class="select" id="funnel">
            <option value="">Tutti</option>
            <option value="TOFU">TOFU</option>
            <option value="MOFU">MOFU</option>
            <option value="BOFU">BOFU</option>
          </select>
        </div>

        <div>
          <label for="status">Stato</label>
          <select class="select" id="status">
            <option value="">Tutti</option>
            <option value="Candidate">Candidato</option>
            <option value="Tested">In test</option>
            <option value="Validated">Validato</option>
            <option value="Retired">Ritirato</option>
          </select>
        </div>

        <div>
          <label for="production">Produzione</label>
          <select class="select" id="production">
            <option value="">Tutte</option>
            <option value="Low">Bassa</option>
            <option value="Medium">Media</option>
            <option value="High">Alta</option>
          </select>
        </div>

        <div>
          <label for="mechanism">Meccanismo</label>
          <select class="select" id="mechanism">
            <option value="">Tutti</option>
            <option value="Hook">Hook</option>
            <option value="Proof">Prova</option>
            <option value="Objection-kill">Obiezioni</option>
            <option value="Offer">Offerta</option>
            <option value="Trust">Fiducia</option>
            <option value="Urgency">Urgenza</option>
            <option value="Hook + Proof">Hook + prova</option>
            <option value="Hook + Offer">Hook + offerta</option>
            <option value="Hook + Objection-kill">Hook + obiezioni</option>
            <option value="Proof + Offer">Prova + offerta</option>
            <option value="Trust + Proof">Fiducia + prova</option>
          </select>
        </div>

        <div>
          <label for="sort">Ordina</label>
          <select class="select" id="sort">
            <option value="id_asc" selected>ID (P001→P035)</option>
            <option value="status_then_name">Stato → Nome</option>
            <option value="name_asc">Nome A→Z</option>
            <option value="tat_asc">Tempo (più rapido)</option>
            <option value="funnel_then_name">Funnel → Nome</option>
          </select>
        </div>
      </div>

      <div class="footer">
        <div id="resultInfo">—</div>
        <div><button class="btn" id="btnReset">Azzera filtri</button></div>
      </div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer" style="margin-top:16px;">
      <div>Obiettivo: una macchina di produzione conversion-driven (tempi rapidi, varianti utili, costi sotto controllo).</div>
      <div style="opacity:.85">Hai un caso forte? Portalo e lo trasformiamo in pattern.</div>
    </div>

  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true">
    <div class="modalbox">
      <div class="modalhead">
        <div>
          <h3 id="mTitle">—</h3>
          <div class="sub" id="mSub">—</div>
        </div>
        <button class="btn" id="mClose">✕ Chiudi</button>
      </div>

      <div class="modalcontent">
        <div class="panel">
          <h4>Ricetta creativa</h4>
          <div class="steps" id="mSteps"></div>
        </div>

        <div class="panel">
          <h4>Dettagli operativi</h4>
          <div class="kv" id="mKV"></div>

          <div style="height:10px"></div>
          <h4>Rischi da evitare</h4>
          <ul class="list" id="mRisks"></ul>

          <div style="height:10px"></div>
          <h4>Note</h4>
          <div style="color:rgba(255,255,255,.78);font-size:12px;line-height:1.45" id="mNotes"></div>
        </div>
      </div>

      <div class="modalactions">
        <button class="btn" id="btnCopy">⧉ Copia ricetta</button>
        <button class="btn primary" id="btnCopyCard">⧉ Copia scheda</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="dot"></span>
    <span id="toastText">Copiato</span>
  </div>

  <script>
    /* ======================
       35 pattern EMBEDDED
       ====================== */
    const BASE_PATTERNS = [
      {id:"P001",name:"Problem-first Demo",funnel:"BOFU",mechanism:"Hook + Proof",bestFor:["Beauty","FMCG","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Apri col problema (visual): “Se anche tu…”"},{t:"2–6s",d:"Demo immediata (in-use), senza spiegoni"},{t:"6–12s",d:"1 prova concreta / dettaglio che convince"},{t:"CTA",d:"Cosa comprare + perché ora (offerta/logistica se utile)"}],
        requiredAssets:["Prodotto","In-use","Testo a schermo"],risks:["Hook lungo","Prova poco visibile"],notes:"Scalabile: cambia solo scenario e angolo."
      },
      {id:"P002",name:"Before/After ultra-rapido",funnel:"BOFU",mechanism:"Proof",bestFor:["Beauty","Cleaning","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–1s",d:"Before chiaro (close-up)"},{t:"1–6s",d:"Applicazione/uso (ripresa ravvicinata)"},{t:"6–10s",d:"After + dettaglio prova"},{t:"CTA",d:"CTA semplice: “Lo trovi su Shop”"}],
        requiredAssets:["Prodotto","Luce buona"],risks:["After poco chiaro","Riprese scure"],notes:"Perfetto per volumi alti."
      },
      {id:"P003",name:"Confronto 1 criterio (A vs B)",funnel:"MOFU",mechanism:"Proof + Offer",bestFor:["Electronics","Home","Beauty"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Questo vs quello su [1 criterio]”"},{t:"2–12s",d:"Confronto visivo side-by-side"},{t:"12–16s",d:"Sintesi in 1 frase: perché vince"},{t:"CTA",d:"Acquisto su Shop + offerta (se presente)"}],
        requiredAssets:["A/B","Close-up","Testo a schermo"],risks:["Confronto confuso","Troppi criteri"],notes:"Scegli un solo criterio davvero decisivo."
      },
      {id:"P004",name:"3 motivi + prova (listicle)",funnel:"MOFU",mechanism:"Hook + Proof",bestFor:["Beauty","Electronics","Fashion","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “3 motivi per cui…”"},{t:"2–10s",d:"Motivo 1 + micro-prova visiva"},{t:"10–18s",d:"Motivo 2 + micro-prova"},{t:"18–26s",d:"Motivo 3 + micro-prova + CTA"}],
        requiredAssets:["Prodotto","Testo a schermo"],risks:["Motivi generici","Troppa teoria"],notes:"Ogni motivo deve “vedersi”, non solo dirsi."
      },
      {id:"P005",name:"Obiezione killer: “Sì ma…”",funnel:"BOFU",mechanism:"Hook + Objection-kill",bestFor:["Beauty","Home","Electronics"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Apri con l’obiezione: “Sì ma costa… / dura… / funziona?”"},{t:"2–10s",d:"Risposta con prova: demo / dettaglio / confronto"},{t:"10–16s",d:"Riduci rischio: reso, garanzia, spedizione"},{t:"CTA",d:"CTA chiara: prodotto + variante + motivo"}],
        requiredAssets:["Prodotto","Prova visiva"],risks:["Risposta vaga","Manca riduzione rischio"],notes:"Molto forte quando il prezzo è la frizione #1."
      },
      {id:"P006",name:"Risposta a commento (Q&A)",funnel:"MOFU",mechanism:"Trust + Proof",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–1s",d:"Mostra il commento in overlay"},{t:"1–8s",d:"Risposta diretta + prova visiva"},{t:"8–14s",d:"Dettaglio pratico: taglia/uso/tempo"},{t:"CTA",d:"Chiusura con cosa comprare su Shop"}],
        requiredAssets:["Commento","Prodotto"],risks:["Risposta lunga","Non mostra il prodotto"],notes:"Ottimo per iterazione rapida e fiducia."
      },
      {id:"P007",name:"Unboxing → 1 uso immediato",funnel:"MOFU",mechanism:"Hook + Proof",bestFor:["Electronics","Home","Beauty"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “Arrivato oggi: guardate…”"},{t:"2–10s",d:"Unboxing super rapido (solo essenziale)"},{t:"10–18s",d:"1 uso immediato / demo"},{t:"CTA",d:"CTA + cosa arriva in confezione"}],
        requiredAssets:["Scatola","Prodotto","In-use"],risks:["Unboxing lento","Nessun payoff"],notes:"Il payoff deve arrivare presto."
      },
      {id:"P008",name:"Packaging & consegna (riduzione ansia)",funnel:"BOFU",mechanism:"Trust",bestFor:["Beauty","Food","Electronics"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Arriva così (e perché è sicuro)”"},{t:"2–10s",d:"Mostra imballo + protezioni"},{t:"10–16s",d:"Apri e mostra condizioni perfette"},{t:"CTA",d:"CTA + tempi spedizione/resi (se utile)"}],
        requiredAssets:["Pacco","Prodotto"],risks:["Dettagli inutili","Non chiarisce la sicurezza"],notes:"Riduce frizioni su prodotti fragili."
      },
      {id:"P009",name:"“Come si usa davvero” (micro-tutorial)",funnel:"MOFU",mechanism:"Proof",bestFor:["Beauty","Kitchen","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se lo usi così, cambia tutto”"},{t:"2–10s",d:"Passo 1 (in camera)"},{t:"10–18s",d:"Passo 2 + risultato"},{t:"CTA",d:"CTA + variante consigliata"}],
        requiredAssets:["Prodotto","In-use"],risks:["Troppi passi","Non si vede il risultato"],notes:"Taglia tutto ciò che non è essenziale."
      },
      {id:"P010",name:"“Fail vs Fix”",funnel:"MOFU",mechanism:"Hook + Proof",bestFor:["Beauty","Home","Fitness accessories"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Mostra il fail (errore comune)"},{t:"2–6s",d:"Spiega 1 cosa da non fare (testo a schermo)"},{t:"6–14s",d:"Fix con il prodotto + prova"},{t:"CTA",d:"CTA: cosa comprare + perché risolve"}],
        requiredAssets:["Prodotto","Scenario"],risks:["Fail poco realistico","Fix non dimostrato"],notes:"Ottimo quando l’errore è molto comune."
      },
      {id:"P011",name:"“Prima volta che…” (reazione reale)",funnel:"MOFU",mechanism:"Trust + Proof",bestFor:["Beauty","Gadgets","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “Prima volta che provo…”"},{t:"2–8s",d:"Applicazione/uso con reazione"},{t:"8–14s",d:"Zoom su risultato/dettaglio"},{t:"CTA",d:"CTA + aspettativa corretta (onesto)"}],
        requiredAssets:["Volto/mani","Prodotto"],risks:["Reazione artefatta","Manca prova"],notes:"Credibile > entusiasmo forzato."
      },
      {id:"P012",name:"“Quanto dura / quanto regge” (stress test)",funnel:"BOFU",mechanism:"Proof",bestFor:["Electronics","Home","Tools"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Vediamo se regge davvero”"},{t:"2–12s",d:"Stress test (chiaro e ripetibile)"},{t:"12–18s",d:"Risultato + dettaglio prova"},{t:"CTA",d:"CTA + garanzia/reso se utile"}],
        requiredAssets:["Setup test","Prodotto"],risks:["Test poco credibile","Non mostra dopo"],notes:"Forte per claim su resistenza/qualità."
      },
      {id:"P013",name:"“Prezzo spiegato” (value breakdown)",funnel:"BOFU",mechanism:"Trust + Offer",bestFor:["Electronics","Beauty premium","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Perché costa così (e cosa include)”"},{t:"2–10s",d:"3 elementi di valore (materiali, durata, resa)"},{t:"10–16s",d:"Confronto costo-per-uso / costo-per-pezzo"},{t:"CTA",d:"CTA + eventuale bundle/offerta"}],
        requiredAssets:["Prodotto","Testo numeri"],risks:["Numeri confusi","Troppe giustificazioni"],notes:"Aiuta quando il prezzo è la frizione #1."
      },
      {id:"P014",name:"Bundle builder (scelta guidata)",funnel:"BOFU",mechanism:"Offer",bestFor:["Beauty","Food","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se sei [profilo], prendi questo bundle”"},{t:"2–12s",d:"Mostra 2–3 prodotti + motivo (rapido)"},{t:"12–18s",d:"Risultato atteso / uso"},{t:"CTA",d:"CTA: bundle + variante"}],
        requiredAssets:["3 SKU","Testo a schermo"],risks:["Bundle troppo lungo","Motivi vaghi"],notes:"Riduce indecisione e aumenta AOV."
      },
      {id:"P015",name:"Garanzia & reso senza ansia",funnel:"BOFU",mechanism:"Trust",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se non ti va bene…”"},{t:"2–10s",d:"Reso/garanzia in 2 frasi (chiaro)"},{t:"10–16s",d:"Mostra qualità/dettaglio (rassicurazione)"},{t:"CTA",d:"CTA + invito all’acquisto"}],
        requiredAssets:["Testo chiaro","Prodotto"],risks:["Informazioni non chiare","Tono difensivo"],notes:"Molto utile per rischio percepito alto."
      },
      {id:"P016",name:"UGC “amico/a che consiglia”",funnel:"MOFU",mechanism:"Trust + Proof",bestFor:["Beauty","Food","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook colloquiale: “Ok, te lo dico subito…”"},{t:"2–10s",d:"Uso reale (camera a mano)"},{t:"10–16s",d:"1 prova concreta + 1 limite (onesto)"},{t:"CTA",d:"CTA: dove trovarlo su Shop"}],
        requiredAssets:["Volto/voce","In-use"],risks:["Sembra recitato","Prova debole"],notes:"Autenticità prima di tutto."
      },
      {id:"P017",name:"Myth-busting (sfata un mito)",funnel:"MOFU",mechanism:"Hook + Proof",bestFor:["Beauty","Home","Fitness accessories"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “No, non è vero che…”"},{t:"2–10s",d:"Prova (demo)"},
               {t:"10–16s",d:"Perché in 1 frase"},
               {t:"CTA",d:"CTA + cosa comprare"}],
        requiredAssets:["Demo","Testo a schermo"],risks:["Mito poco diffuso","Spiegazione lunga"],notes:"Funziona se il mito è davvero comune."
      },
      {id:"P018",name:"ASMR / soddisfazione visiva",funnel:"MOFU",mechanism:"Proof",bestFor:["Cleaning","Kitchen","Home"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook visivo: “Guarda questo”"},
               {t:"2–14s",d:"Sequenza soddisfacente (suoni/texture)"},
               {t:"14–18s",d:"Risultato finale (prima/dopo rapido)"},
               {t:"CTA",d:"CTA discreta + nome prodotto"}],
        requiredAssets:["Audio pulito","Luce","Prodotto"],risks:["Troppo lungo","Manca risultato"],notes:"Amplifica la prova, non la sostituisce."
      },
      {id:"P019",name:"“Top 3 usi” (3 contesti)",funnel:"MOFU",mechanism:"Proof",bestFor:["Home","Kitchen","Beauty"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “3 modi in cui lo uso”"},
               {t:"2–14s",d:"Uso 1 / Uso 2 / Uso 3 (tagli rapidi)"},
               {t:"14–18s",d:"Sintesi: per chi è"},
               {t:"CTA",d:"CTA: prodotto + variante"}],
        requiredAssets:["3 scene","Prodotto"],risks:["Usi non distinti","Video caotico"],notes:"Aumenta rilevanza e riduce “non fa per me”."
      },
      {id:"P020",name:"“Solo questo dettaglio” (macro close-up)",funnel:"BOFU",mechanism:"Proof",bestFor:["Beauty","Fashion details","Electronics"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Guarda questo dettaglio”"},
               {t:"2–10s",d:"Macro/zoom (materiale, finitura, texture)"},
               {t:"10–16s",d:"Perché conta (1 frase)"},
               {t:"CTA",d:"CTA: modello/variante"}],
        requiredAssets:["Macro","Luce"],risks:["Dettaglio non rilevante","Manca contesto"],notes:"Perfetto per qualità percepita."
      },
      {id:"P021",name:"Taglia/fit guidato",funnel:"BOFU",mechanism:"Trust + Proof",bestFor:["Fashion"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se hai la mia altezza, prendi…”"},
               {t:"2–10s",d:"Mostra fit davanti/lato"},
               {t:"10–16s",d:"2 info pratiche: elasticità / lunghezza / vita"},
               {t:"CTA",d:"CTA: taglia consigliata + alternative"}],
        requiredAssets:["Full body","Luce"],risks:["Non mostra misure","Troppo parlato"],notes:"Riduce resi e aumenta conversione."
      },
      {id:"P022",name:"“Cosa c’è nella scatola” (essenziale)",funnel:"MOFU",mechanism:"Proof",bestFor:["Electronics","Gadgets"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Dentro c’è anche…”"},
               {t:"2–10s",d:"Contenuto (tagli rapidi)"},
               {t:"10–16s",d:"Feature #1 che conta (demo)"},
               {t:"CTA",d:"CTA + compatibilità"}],
        requiredAssets:["Box","Prodotto","Demo"],risks:["Elenco infinito","Nessun uso"],notes:"Focus su ciò che cambia l’esperienza."
      },
      {id:"P023",name:"“Smetti di fare così” (consiglio diretto)",funnel:"MOFU",mechanism:"Hook + Proof",bestFor:["Beauty","Home","Kitchen"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “Smetti di fare così”"},
               {t:"2–8s",d:"Errore + perché (breve)"},
               {t:"8–14s",d:"Soluzione con prodotto (demo)"},
               {t:"CTA",d:"CTA + risultato"}],
        requiredAssets:["Scenario","Prodotto"],risks:["Tono aggressivo","Errore poco comune"],notes:"Tono fermo ma utile."
      },
      {id:"P024",name:"Fiducia: ingredienti / materiali / certificazioni",funnel:"BOFU",mechanism:"Trust",bestFor:["Beauty","Food","Baby","Home"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se ti preoccupa [tema], guarda qui”"},
               {t:"2–10s",d:"Mostra etichetta/certificazione (close-up)"},
               {t:"10–16s",d:"Traduci in beneficio reale (1 frase)"},
               {t:"CTA",d:"CTA + per chi è/non è"}],
        requiredAssets:["Etichetta","Close-up"],risks:["Troppi claim","Linguaggio tecnico"],notes:"Semplice, concreto, verificabile."
      },
      {id:"P025",name:"Urgenza soft (scadenza reale)",funnel:"BOFU",mechanism:"Urgency",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Fino a [data] c’è…”"},
               {t:"2–10s",d:"Prodotto + 1 prova"},
               {t:"10–16s",d:"Cosa cambia dopo la scadenza"},
               {t:"CTA",d:"CTA diretta"}],
        requiredAssets:["Prodotto","Testo data"],risks:["Urgenza non credibile","Solo promo"],notes:"Urgenza solo se reale e chiara."
      },
      {id:"P026",name:"Mini-recensione “pro e contro”",funnel:"MOFU",mechanism:"Trust + Proof",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Onesta: pro e contro”"},
               {t:"2–10s",d:"2 pro con prova visiva"},
               {t:"10–14s",d:"1 contro (piccolo) + workaround"},
               {t:"CTA",d:"CTA + per chi è ideale"}],
        requiredAssets:["Prodotto","Demo"],risks:["Contro troppo pesante","Manca prova"],notes:"Aumenta credibilità → converte meglio."
      },
      {id:"P027",name:"“A chi lo sconsiglio” (qualifica)",funnel:"BOFU",mechanism:"Trust",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “Non comprarlo se…”"},
               {t:"2–10s",d:"2 casi in cui non è adatto"},
               {t:"10–16s",d:"Per chi è perfetto + prova"},
               {t:"CTA",d:"CTA: variante consigliata"}],
        requiredAssets:["Prodotto","Testo a schermo"],risks:["Sconsigli generici","Non qualifica davvero"],notes:"Riduce resi e aumenta qualità traffico."
      },
      {id:"P028",name:"“Quanto ci metto” (time-lapse)",funnel:"MOFU",mechanism:"Proof",bestFor:["Cleaning","Kitchen","Beauty"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Ci metto solo…”"},
               {t:"2–14s",d:"Time-lapse del processo"},
               {t:"14–18s",d:"Risultato finale (close-up)"},
               {t:"CTA",d:"CTA + dove trovarlo"}],
        requiredAssets:["Tripod","Luce"],risks:["Noioso","Risultato non visibile"],notes:"Ottimo per “risparmio tempo”."
      },
      {id:"P029",name:"“Stessa cosa, ma meglio” (upgrade)",funnel:"MOFU",mechanism:"Proof + Offer",bestFor:["Home","Gadgets","Beauty"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se usi ancora [vecchio], guarda questo”"},
               {t:"2–10s",d:"Differenza in uso (1 criterio)"},
               {t:"10–16s",d:"Benefit + dettaglio prova"},
               {t:"CTA",d:"CTA + perché conviene ora"}],
        requiredAssets:["Vecchio vs nuovo","Demo"],risks:["Differenza non chiara","Troppi criteri"],notes:"Sempre 1 criterio = chiarezza."
      },
      {id:"P030",name:"“Da vicino” (texture/consistenza)",funnel:"MOFU",mechanism:"Proof",bestFor:["Beauty","Food"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “La consistenza è così”"},
               {t:"2–12s",d:"Macro + applicazione/spalmatura"},
               {t:"12–16s",d:"Risultato (finish)"},
               {t:"CTA",d:"CTA + variante"}],
        requiredAssets:["Macro","Luce"],risks:["Sfocato","Non mostra risultato"],notes:"Molto forte per sensorialità."
      },
      {id:"P031",name:"FAQ rapid-fire (3 domande)",funnel:"BOFU",mechanism:"Trust",bestFor:["Tutte"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “3 domande che mi fate sempre”"},
               {t:"2–14s",d:"Q1/Q2/Q3 (2–4s ciascuna) + micro-prova"},
               {t:"CTA",d:"CTA finale"}],
        requiredAssets:["Testo Q/A","Prodotto"],risks:["Risposte vaghe","Domande non reali"],notes:"Usa domande reali da commenti/DM."
      },
      {id:"P032",name:"Social proof (montaggio breve)",funnel:"BOFU",mechanism:"Trust",bestFor:["Tutte"],productionLevel:"High",tatTarget:"10d",costBucket:"€€€",status:"Tested",
        recipe:[{t:"0–2s",d:"Hook: “Ecco cosa dicono”"},
               {t:"2–14s",d:"3–5 clip UGC (1 frase ciascuna)"},
               {t:"14–18s",d:"1 prova concreta del prodotto"},
               {t:"CTA",d:"CTA + best-seller"}],
        requiredAssets:["UGC","Diritti"],risks:["UGC lungo","Nessuna prova"],notes:"Potente se le clip sono davvero diverse tra loro."
      },
      {id:"P033",name:"Dietro le quinte (processo qualità)",funnel:"MOFU",mechanism:"Trust + Proof",bestFor:["Beauty artigianale","Food","Home"],productionLevel:"High",tatTarget:"10d",costBucket:"€€€",status:"Candidate",
        recipe:[{t:"0–2s",d:"Hook: “Ecco come lo facciamo”"},
               {t:"2–14s",d:"2–3 passaggi del processo (visual pulito)"},
               {t:"14–18s",d:"Dettaglio qualità (materiale/ingrediente)"},
               {t:"CTA",d:"CTA + perché conviene"}],
        requiredAssets:["B-roll","Location"],risks:["Troppo lento","Non rilevante"],notes:"Usalo solo se il processo aumenta davvero fiducia."
      },
      {id:"P034",name:"Creator-style “consiglio secco”",funnel:"MOFU",mechanism:"Hook + Offer",bestFor:["Beauty","Home","Electronics"],productionLevel:"Low",tatTarget:"72h",costBucket:"€",status:"Validated",
        recipe:[{t:"0–2s",d:"Hook: “Se devi comprarne uno, prendi questo”"},
               {t:"2–10s",d:"1 motivo forte + prova visiva"},
               {t:"10–16s",d:"Per chi è / non è"},
               {t:"CTA",d:"CTA: modello/variante"}],
        requiredAssets:["Volto/voce","Prodotto"],risks:["Motivo debole","Prova assente"],notes:"Molto diretto, molto conversion."
      },
      {id:"P035",name:"“Settimana 1–2–3” (progress)",funnel:"MOFU",mechanism:"Proof",bestFor:["Beauty","Fitness accessories","Home"],productionLevel:"Medium",tatTarget:"7d",costBucket:"€€",status:"Candidate",
        recipe:[{t:"0–2s",d:"Hook: “Ecco com’è dopo X giorni”"},
               {t:"2–14s",d:"Progress (day 1/7/14)"},
               {t:"14–18s",d:"Cosa aspettarsi (realistico)"},
               {t:"CTA",d:"CTA + come iniziare"}],
        requiredAssets:["Progress footage"],risks:["Progress non credibile","Aspettative alte"],notes:"Quando i risultati richiedono tempo."
      }
    ];

    const els = {
      grid: document.getElementById("grid"),
      q: document.getElementById("q"),
      funnel: document.getElementById("funnel"),
      status: document.getElementById("status"),
      production: document.getElementById("production"),
      mechanism: document.getElementById("mechanism"),
      sort: document.getElementById("sort"),
      btnReset: document.getElementById("btnReset"),
      btnReload: document.getElementById("btnReload"),
      btnExport: document.getElementById("btnExport"),
      btnHow: document.getElementById("btnHow"),
      dataStatus: document.getElementById("dataStatus"),
      statCount: document.getElementById("statCount"),
      statFiltered: document.getElementById("statFiltered"),
      resultInfo: document.getElementById("resultInfo"),
      chips: Array.from(document.querySelectorAll(".chip")),
      modal: document.getElementById("modal"),
      mTitle: document.getElementById("mTitle"),
      mSub: document.getElementById("mSub"),
      mSteps: document.getElementById("mSteps"),
      mKV: document.getElementById("mKV"),
      mRisks: document.getElementById("mRisks"),
      mNotes: document.getElementById("mNotes"),
      mClose: document.getElementById("mClose"),
      btnCopy: document.getElementById("btnCopy"),
      btnCopyCard: document.getElementById("btnCopyCard"),
      toast: document.getElementById("toast"),
      toastText: document.getElementById("toastText"),
    };

    const state = { patterns: [], filtered: [], quick: new Set(), selected: null, source: "—" };

    function toast(msg){
      els.toastText.textContent = msg;
      els.toast.classList.add("on");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => els.toast.classList.remove("on"), 1400);
    }

    function norm(s){ return (s ?? "").toString().toLowerCase().trim(); }

    function statusClass(s){
      const v = norm(s);
      if(v === "validated") return "validated";
      if(v === "tested") return "tested";
      if(v === "candidate") return "candidate";
      if(v === "retired") return "retired";
      return "";
    }

    function labelStatus(s){
      const v = norm(s);
      if(v === "validated") return "Validato";
      if(v === "tested") return "In test";
      if(v === "candidate") return "Candidato";
      if(v === "retired") return "Ritirato";
      return s || "—";
    }

    function labelProd(s){
      const v = norm(s);
      if(v === "low") return "Bassa";
      if(v === "medium") return "Media";
      if(v === "high") return "Alta";
      return s || "—";
    }

    function toTatDays(tat){
      if(!tat) return 999;
      const t = norm(tat);
      if(t.endsWith("h")){
        const n = parseFloat(t.replace("h",""));
        if(!isNaN(n)) return Math.max(1, Math.round(n/24));
      }
      if(t.endsWith("d")){
        const n = parseFloat(t.replace("d",""));
        if(!isNaN(n)) return n;
      }
      return 999;
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function applyQuickFilters(p){
      for(const qf of state.quick){
        const [k, v] = qf.split(":");
        const pv = p[k];
        if(Array.isArray(pv)){
          if(!pv.map(norm).includes(norm(v))) return false;
        }else{
          if(norm(pv) !== norm(v)) return false;
        }
      }
      return true;
    }

    function filterPatterns(){
      const q = norm(els.q.value);
      const funnel = els.funnel.value;
      const status = els.status.value;
      const production = els.production.value;
      const mechanism = els.mechanism.value;

      let out = state.patterns.filter(p => {
        if(funnel && norm(p.funnel) !== norm(funnel)) return false;
        if(status && norm(p.status) !== norm(status)) return false;
        if(production && norm(p.productionLevel) !== norm(production)) return false;
        if(mechanism && norm(p.mechanism) !== norm(mechanism)) return false;
        if(!applyQuickFilters(p)) return false;

        if(q){
          const hay = [
            p.id, p.name, p.funnel, p.mechanism, p.productionLevel, p.tatTarget, p.costBucket, p.status,
            ...(p.bestFor || []), ...(p.requiredAssets || []), ...(p.risks || []),
            ...(p.recipe || []).map(x => `${x.t} ${x.d}`),
            p.notes
          ].join(" • ");
          if(!norm(hay).includes(q)) return false;
        }
        return true;
      });

      const s = els.sort.value;
      out.sort((a,b) => {
        const statusRank = (x) => ({validated:0, tested:1, candidate:2, retired:3}[norm(x.status)] ?? 9);

        if(s === "id_asc") return (a.id ?? "").localeCompare(b.id ?? "");

        if(s === "status_then_name"){
          const d = statusRank(a) - statusRank(b);
          if(d !== 0) return d;
          return (a.name ?? "").localeCompare(b.name ?? "");
        }
        if(s === "name_asc") return (a.name ?? "").localeCompare(b.name ?? "");
        if(s === "tat_asc") return toTatDays(a.tatTarget) - toTatDays(b.tatTarget);
        if(s === "funnel_then_name"){
          const fr = (x) => ({tofu:0, mofu:1, bofu:2}[norm(x.funnel)] ?? 9);
          const d = fr(a) - fr(b);
          if(d !== 0) return d;
          return (a.name ?? "").localeCompare(b.name ?? "");
        }
        return 0;
      });

      state.filtered = out;
    }

    function render(){
      filterPatterns();

      els.statCount.textContent = state.patterns.length;
      els.statFiltered.textContent = `Mostrati: ${state.filtered.length}`;

      const active = [];
      if(els.q.value.trim()) active.push(`ricerca="${els.q.value.trim()}"`);
      if(els.funnel.value) active.push(`funnel=${els.funnel.value}`);
      if(els.status.value) active.push(`stato=${labelStatus(els.status.value)}`);
      if(els.production.value) active.push(`produzione=${labelProd(els.production.value)}`);
      if(els.mechanism.value) active.push(`meccanismo=${els.mechanism.value}`);
      if(state.quick.size) active.push(`rapidi=[${Array.from(state.quick).map(x=>{
        const [k,v]=x.split(":");
        return k==="status" ? `stato:${labelStatus(v)}` : x;
      }).join(", ")}]`);

      els.resultInfo.textContent = active.length ? `Filtri attivi: ${active.join(" · ")}` : "Nessun filtro attivo";

      els.grid.innerHTML = "";
      const frag = document.createDocumentFragment();

      state.filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "pattern";
        card.tabIndex = 0;

        const statusLabel = labelStatus(p.status || "—");
        const hot = norm(p.funnel) === "bofu" ? "hot" : "";
        const cool = norm(p.status) === "validated" ? "cool" : "";

        card.innerHTML = `
          <div class="p-top">
            <div class="pid">
              <span style="display:inline-block;width:8px;height:8px;border-radius:99px;background:linear-gradient(135deg,var(--tt-cyan),var(--tt-pink));"></span>
              <span>${escapeHtml(p.id || "")}</span>
            </div>
            <div class="status ${statusClass(p.status)}">${escapeHtml(statusLabel)}</div>
          </div>

          <div class="p-name">${escapeHtml(p.name || "")}</div>

          <div class="p-meta">
            <span class="badge ${cool}">Funnel: ${escapeHtml(p.funnel || "—")}</span>
            <span class="badge">Mecc: ${escapeHtml(p.mechanism || "—")}</span>
            <span class="badge ${hot}">Prod: ${escapeHtml(labelProd(p.productionLevel || "—"))}</span>
            <span class="badge">Tempo: ${escapeHtml(p.tatTarget || "—")}</span>
            <span class="badge">Costo: ${escapeHtml(p.costBucket || "—")}</span>
          </div>
        `;

        card.addEventListener("click", () => openModal(p));
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            openModal(p);
          }
        });

        frag.appendChild(card);
      });

      els.grid.appendChild(frag);

      const src = state.source === "merged"
        ? "Dati: inclusi + override patterns.json (se presente)"
        : "Dati: inclusi";
      els.dataStatus.textContent = `${src} · Libreria pronta`;
    }

    function openModal(p, opts={}){
      state.selected = p;
      const isGuide = !!opts.isGuide;

      els.mTitle.textContent = isGuide ? (opts.title || "Guida rapida") : `${p.id || ""} — ${p.name || ""}`;

      if(isGuide){
        els.mSub.textContent = opts.subtitle || "Indicazioni pratiche per usare la libreria e produrre contenuti che convertono.";
      }else{
        els.mSub.textContent = `${p.funnel || "—"} · ${p.mechanism || "—"} · Produzione ${labelProd(p.productionLevel || "—")} · Tempo ${p.tatTarget || "—"} · Costo ${p.costBucket || "—"} · ${labelStatus(p.status || "—")}`;
      }

      els.mSteps.innerHTML = "";
      (p.recipe || []).forEach(step => {
        const div = document.createElement("div");
        div.className = "step";
        div.innerHTML = `<div class="t">${escapeHtml(step.t || "")}</div><div class="d">${escapeHtml(step.d || "")}</div>`;
        els.mSteps.appendChild(div);
      });

      const kv = isGuide ? (opts.kv || []) : [
        ["Dove nel funnel", p.funnel || "—"],
        ["Meccanismo", p.mechanism || "—"],
        ["Categorie adatte", (p.bestFor || []).join(", ") || "—"],
        ["Asset necessari", (p.requiredAssets || []).join(", ") || "—"],
        ["Produzione", labelProd(p.productionLevel || "—")],
        ["Tempo target", p.tatTarget || "—"],
        ["Costo", p.costBucket || "—"],
        ["Stato", labelStatus(p.status || "—")]
      ];
      els.mKV.innerHTML = kv.map(([k,v]) => `<b>${escapeHtml(k)}</b><span>${escapeHtml(v)}</span>`).join("");

      els.mRisks.innerHTML = "";
      const risks = isGuide ? (opts.risks || ["—"]) : ((p.risks && p.risks.length) ? p.risks : ["—"]);
      risks.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r;
        els.mRisks.appendChild(li);
      });

      els.mNotes.textContent = isGuide ? (opts.notes || "—") : (p.notes || "—");

      els.modal.classList.add("on");
      setTimeout(() => els.mClose.focus(), 50);
    }

    function closeModal(){
      els.modal.classList.remove("on");
      state.selected = null;
    }

    async function copyRecipe(){
      const p = state.selected;
      if(!p) return;

      const lines = [];
      lines.push(`${p.id} — ${p.name}`);
      lines.push(`Funnel: ${p.funnel || "—"} | Meccanismo: ${p.mechanism || "—"} | Produzione: ${labelProd(p.productionLevel || "—")} | Tempo: ${p.tatTarget || "—"} | Costo: ${p.costBucket || "—"} | Stato: ${labelStatus(p.status || "—")}`);
      lines.push("");
      (p.recipe || []).forEach(s => lines.push(`${s.t}: ${s.d}`));
      lines.push("");
      if(p.requiredAssets?.length) lines.push(`Asset necessari: ${p.requiredAssets.join(", ")}`);
      if(p.risks?.length) lines.push(`Rischi: ${p.risks.join(", ")}`);
      if(p.notes) lines.push(`Note: ${p.notes}`);

      await navigator.clipboard.writeText(lines.join("\n"));
      toast("Ricetta copiata");
    }

    async function copyCard(){
      const p = state.selected;
      if(!p) return;
      await navigator.clipboard.writeText(JSON.stringify(p, null, 2));
      toast("Scheda copiata");
    }

    function resetAll(){
      els.q.value = "";
      els.funnel.value = "";
      els.status.value = "";
      els.production.value = "";
      els.mechanism.value = "";
      state.quick.clear();
      els.chips.forEach(c => c.classList.remove("on"));
      const def = els.chips.find(c => c.dataset.quick === "status:Validated");
      if(def){ def.classList.add("on"); state.quick.add("status:Validated"); }
      render();
    }

    function exportJSON(){
      const data = { exportedAt: new Date().toISOString(), patterns: state.patterns };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pattern-library.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Esportazione avviata");
    }

    function sanitize(arr){
      return arr.map(p => ({
        id: p.id ?? "",
        name: p.name ?? "",
        funnel: p.funnel ?? "",
        mechanism: p.mechanism ?? "",
        bestFor: Array.isArray(p.bestFor) ? p.bestFor : [],
        recipe: Array.isArray(p.recipe) ? p.recipe.map(s => ({t:s.t ?? "", d:s.d ?? ""})) : [],
        requiredAssets: Array.isArray(p.requiredAssets) ? p.requiredAssets : [],
        productionLevel: p.productionLevel ?? "",
        tatTarget: p.tatTarget ?? "",
        costBucket: p.costBucket ?? "",
        risks: Array.isArray(p.risks) ? p.risks : [],
        status: p.status ?? "Candidate",
        notes: p.notes ?? ""
      })).filter(p => p.id && p.name);
    }

    function mergeById(baseArr, overrideArr){
      const map = new Map();
      baseArr.forEach(p => map.set(p.id, p));
      overrideArr.forEach(p => {
        if(!p?.id) return;
        map.set(p.id, {...map.get(p.id), ...p});
      });
      return Array.from(map.values()).sort((a,b) => (a.id||"").localeCompare(b.id||""));
    }

    async function loadPatterns(){
      state.quick.clear();
      const def = els.chips.find(c => c.dataset.quick === "status:Validated");
      els.chips.forEach(c => c.classList.remove("on"));
      if(def){ def.classList.add("on"); state.quick.add("status:Validated"); }

      const base = sanitize(BASE_PATTERNS);

      try{
        const res = await fetch("./patterns.json", { cache: "no-store" });
        if(res.ok){
          const json = await res.json();
          const overrides = Array.isArray(json) ? json : (json?.patterns || []);
          const merged = mergeById(base, sanitize(overrides));
          state.patterns = merged;
          state.source = "merged";
          render();
          return;
        }
      }catch(e){ /* ignore */ }

      state.patterns = base;
      state.source = "embedded";
      render();
    }

    function openGuide(){
      const guide = {
        id:"GUIDA",
        name:"Guida rapida",
        funnel:"—",
        mechanism:"—",
        productionLevel:"—",
        tatTarget:"—",
        costBucket:"—",
        status:"—",
        bestFor:[],
        requiredAssets:[],
        risks:[],
        notes:"Obiettivo: produrre volume utile, imparare in fretta e scalare ciò che funziona davvero.",
        recipe:[
          {t:"1) Selezione", d:"Scegli 2 pattern Validati (esecuzione) + 2 pattern In test (esplorazione)."},
          {t:"2) Varianti", d:"Cambia un solo elemento per volta (hook, prova, offerta, scenario)."},
          {t:"3) Disciplina", d:"Un video = una sola idea: hook forte, prova concreta, chiusura chiara."},
          {t:"4) Qualità", d:"Prodotto subito visibile. Testo leggibile. Claim solo con prova."},
          {t:"5) Review", d:"Ogni settimana: scala, itera o stop. Niente contenuti casuali."}
        ]
      };

      openModal(guide, {
        isGuide:true,
        subtitle:"Come ottenere risultati con una produzione conversion-driven (semplice, ripetibile, misurabile).",
        kv:[
          ["TOFU/MOFU/BOFU", "Scoperta → considerazione → acquisto."],
          ["Hook", "I primi secondi che fermano lo scroll."],
          ["Prova", "Demo / dettagli / confronto: ciò che fa credere."],
          ["Obiezione", "Prezzo, qualità, fit, spedizione, reso…"],
          ["CTA", "Chiudi con cosa comprare e perché ora."]
        ],
        risks:[
          "Aprire lento: perdi attenzione nei primi 2 secondi.",
          "Troppe idee nello stesso video: confusione e bassa conversione.",
          "Claim senza prova: perdi fiducia e performance.",
          "CTA poco chiara: non si capisce cosa comprare."
        ],
        notes:"Se vuoi, puoi aggiungere/aggiornare pattern con patterns.json: questa pagina li integra senza perdere quelli base."
      });
    }

    [els.q, els.funnel, els.status, els.production, els.mechanism, els.sort].forEach(el => {
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    els.btnReset.addEventListener("click", resetAll);
    els.btnReload.addEventListener("click", loadPatterns);
    els.btnExport.addEventListener("click", exportJSON);
    els.btnHow.addEventListener("click", openGuide);

    els.mClose.addEventListener("click", closeModal);
    els.modal.addEventListener("click", (e) => { if(e.target === els.modal) closeModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape" && els.modal.classList.contains("on")) closeModal(); });

    els.btnCopy.addEventListener("click", copyRecipe);
    els.btnCopyCard.addEventListener("click", copyCard);

    els.chips.forEach(chip => {
      chip.addEventListener("click", () => {
        const key = chip.dataset.quick;
        if(state.quick.has(key)){
          state.quick.delete(key);
          chip.classList.remove("on");
        }else{
          state.quick.add(key);
          chip.classList.add("on");
        }
        render();
      });
    });

    loadPatterns();
  </script>
</body>
</html>
```
